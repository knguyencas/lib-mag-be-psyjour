<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Debug Tool</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .section {
            background: #252526;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #007acc;
        }
        h1 { color: #4ec9b0; }
        h2 { color: #dcdcaa; }
        button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
        }
        button:hover {
            background: #1177bb;
        }
        .success { color: #4ec9b0; }
        .error { color: #f48771; }
        .warning { color: #ce9178; }
        pre {
            background: #1e1e1e;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            border: 1px solid #3c3c3c;
        }
        .result {
            margin-top: 10px;
        }
        input {
            background: #3c3c3c;
            border: 1px solid #555;
            color: #d4d4d4;
            padding: 8px;
            margin: 5px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }
        .status {
            padding: 5px 10px;
            border-radius: 4px;
            display: inline-block;
            margin: 5px 0;
        }
        .status.ok { background: #1a472a; color: #73c991; }
        .status.fail { background: #4b1818; color: #f48771; }
    </style>
</head>
<body>
    <h1>üîç Psyche Journey - API Debug Tool</h1>
    
    <div class="section">
        <h2>1Ô∏è‚É£ Configuration</h2>
        <label>Backend URL:</label>
        <input type="text" id="apiUrl" value="http://localhost:3000/api" style="width: 300px;">
        <button onclick="saveConfig()">Save</button>
        <div id="configStatus" class="result"></div>
    </div>

    <div class="section">
        <h2>2Ô∏è‚É£ Connection Test</h2>
        <button onclick="testConnection()">Test Backend Connection</button>
        <div id="connectionResult" class="result"></div>
    </div>

    <div class="section">
        <h2>3Ô∏è‚É£ Test Endpoints</h2>
        <button onclick="testGetGenres()">GET /metadata/genres</button>
        <button onclick="testGetBooks()">GET /books (all)</button>
        <button onclick="testGetPopular()">GET Popular Books</button>
        <button onclick="testGetForYou()">GET For You Books</button>
        <div id="endpointResult" class="result"></div>
    </div>

    <div class="section">
        <h2>4Ô∏è‚É£ Database Check</h2>
        <button onclick="checkDatabase()">Check Database Status</button>
        <div id="dbResult" class="result"></div>
    </div>

    <div class="section">
        <h2>5Ô∏è‚É£ Sample Data</h2>
        <button onclick="showSampleBook()">Show Sample Book Structure</button>
        <div id="sampleResult" class="result"></div>
    </div>

    <script>
        let API_BASE_URL = localStorage.getItem('apiUrl') || 'http://localhost:3000/api';
        document.getElementById('apiUrl').value = API_BASE_URL;

        function saveConfig() {
            API_BASE_URL = document.getElementById('apiUrl').value;
            localStorage.setItem('apiUrl', API_BASE_URL);
            document.getElementById('configStatus').innerHTML = 
                '<span class="success">‚úì Configuration saved!</span>';
        }

        async function testConnection() {
            const result = document.getElementById('connectionResult');
            result.innerHTML = '<span class="warning">Testing connection...</span>';

            try {
                const response = await fetch(`${API_BASE_URL}/books?limit=1`);
                
                if (response.ok) {
                    result.innerHTML = `
                        <div class="status ok">‚úì Connection successful!</div>
                        <pre>Status: ${response.status} ${response.statusText}</pre>
                    `;
                } else {
                    result.innerHTML = `
                        <div class="status fail">‚úó Connection failed</div>
                        <pre>Status: ${response.status} ${response.statusText}</pre>
                    `;
                }
            } catch (error) {
                result.innerHTML = `
                    <div class="status fail">‚úó Cannot connect to backend</div>
                    <pre class="error">${error.message}</pre>
                    <p class="warning">Is backend running on ${API_BASE_URL}?</p>
                `;
            }
        }

        async function testGetGenres() {
            const result = document.getElementById('endpointResult');
            result.innerHTML = '<span class="warning">Fetching genres...</span>';

            try {
                const response = await fetch(`${API_BASE_URL}/books/metadata/genres`);
                const data = await response.json();

                if (data.success && data.data) {
                    result.innerHTML = `
                        <div class="status ok">‚úì Genres loaded successfully</div>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                } else {
                    result.innerHTML = `
                        <div class="status fail">‚úó Unexpected response format</div>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                }
            } catch (error) {
                result.innerHTML = `
                    <div class="status fail">‚úó Error</div>
                    <pre class="error">${error.message}</pre>
                `;
            }
        }

        async function testGetBooks() {
            const result = document.getElementById('endpointResult');
            result.innerHTML = '<span class="warning">Fetching books...</span>';

            try {
                const response = await fetch(`${API_BASE_URL}/books?limit=5&status=published`);
                const data = await response.json();

                if (data.success && data.data) {
                    result.innerHTML = `
                        <div class="status ok">‚úì Books loaded: ${data.data.length} items</div>
                        <p>Total in database: ${data.pagination?.total || 'unknown'}</p>
                        <pre>${JSON.stringify(data.data[0] || {}, null, 2)}</pre>
                    `;
                } else {
                    result.innerHTML = `
                        <div class="status fail">‚úó Unexpected response</div>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                }
            } catch (error) {
                result.innerHTML = `
                    <div class="status fail">‚úó Error</div>
                    <pre class="error">${error.message}</pre>
                `;
            }
        }

        async function testGetPopular() {
            const result = document.getElementById('endpointResult');
            result.innerHTML = '<span class="warning">Fetching popular books...</span>';

            try {
                const response = await fetch(`${API_BASE_URL}/books?limit=5&sortBy=rating&status=published`);
                const data = await response.json();

                result.innerHTML = `
                    <div class="status ok">‚úì Popular books loaded: ${data.data?.length || 0} items</div>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `;
            } catch (error) {
                result.innerHTML = `
                    <div class="status fail">‚úó Error</div>
                    <pre class="error">${error.message}</pre>
                `;
            }
        }

        async function testGetForYou() {
            const result = document.getElementById('endpointResult');
            result.innerHTML = '<span class="warning">Fetching For You books...</span>';

            try {
                const response = await fetch(`${API_BASE_URL}/books?limit=20&sortBy=rating&status=published`);
                const data = await response.json();

                result.innerHTML = `
                    <div class="status ok">‚úì For You books loaded: ${data.data?.length || 0} items</div>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `;
            } catch (error) {
                result.innerHTML = `
                    <div class="status fail">‚úó Error</div>
                    <pre class="error">${error.message}</pre>
                `;
            }
        }

        async function checkDatabase() {
            const result = document.getElementById('dbResult');
            result.innerHTML = '<span class="warning">Checking database...</span>';

            try {
                // Test 1: Count all books
                const allBooks = await fetch(`${API_BASE_URL}/books?limit=1`);
                const allData = await allBooks.json();

                // Test 2: Count published books
                const publishedBooks = await fetch(`${API_BASE_URL}/books?status=published&limit=1`);
                const publishedData = await publishedBooks.json();

                // Test 3: Check genres
                const genresResp = await fetch(`${API_BASE_URL}/books/metadata/genres`);
                const genresData = await genresResp.json();

                result.innerHTML = `
                    <div class="status ok">‚úì Database accessible</div>
                    <h3>Statistics:</h3>
                    <ul>
                        <li>Total books: ${allData.pagination?.total || 0}</li>
                        <li>Published books: ${publishedData.pagination?.total || 0}</li>
                        <li>Available genres: ${genresData.data?.length || 0}</li>
                    </ul>
                    <h3>Genres:</h3>
                    <pre>${JSON.stringify(genresData.data || [], null, 2)}</pre>
                `;

                if (publishedData.pagination?.total === 0) {
                    result.innerHTML += `
                        <div class="status fail">‚ö†Ô∏è WARNING: No published books found!</div>
                        <p class="warning">You need to add books with status='published' to the database.</p>
                    `;
                }
            } catch (error) {
                result.innerHTML = `
                    <div class="status fail">‚úó Database check failed</div>
                    <pre class="error">${error.message}</pre>
                `;
            }
        }

        function showSampleBook() {
            const result = document.getElementById('sampleResult');
            const sampleBook = {
                book_id: "sample-001",
                title: "The Psychology of Money",
                author: "Morgan Housel",
                author_id: "author-001",
                year: 2020,
                publisher: "Harriman House",
                language: "en",
                primary_genre: "Psychology",
                categories: ["Behavioral Psychology"],
                tags: ["money", "finance", "behavior"],
                punchline: "Timeless lessons on wealth, greed, and happiness",
                blurb: "Doing well with money isn't necessarily about what you know. It's about how you behave.",
                coverImage_cloud: {
                    url: "https://images.example.com/cover.jpg",
                    public_id: "sample-001",
                    width: 400,
                    height: 600
                },
                epub: {
                    url: "https://files.example.com/book.epub",
                    public_id: "sample-001-epub"
                },
                rating: 4.5,
                status: "published",
                featured: true,
                view_count: 100,
                download_count: 50,
                pageCount: 256,
                upload_info: {
                    admin_id: "admin-001",
                    uploaded_at: new Date().toISOString()
                },
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            result.innerHTML = `
                <h3>Sample Book Structure:</h3>
                <pre>${JSON.stringify(sampleBook, null, 2)}</pre>
                <p class="warning">Use this structure to insert test data into MongoDB</p>
            `;
        }

        // Auto-run connection test on load
        window.addEventListener('load', () => {
            setTimeout(testConnection, 500);
        });
    </script>
</body>
</html>